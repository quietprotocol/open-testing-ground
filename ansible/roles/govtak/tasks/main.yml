---
# GovTAK Server deployment role

- name: Install required packages for GovTAK Server
  ansible.builtin.include_role:
    name: opkg-packages
  tags:
    - govtak
    - govtak-setup

- name: Ensure GovTAK Server directory exists
  ansible.builtin.file:
    path: "{{ tak_server_dir }}"
    state: directory
    mode: '0755'
  tags:
    - govtak

- name: Check if tak-server repository already exists
  ansible.builtin.stat:
    path: "{{ tak_server_dir }}/.git"
  register: tak_server_repo_exists
  tags:
    - govtak

- name: Clone Cloud-RF TAK Server repository
  ansible.builtin.git:
    repo: "{{ tak_server_repo_url }}"
    dest: "{{ tak_server_dir }}"
    update: yes
    force: yes
  when: not tak_server_repo_exists.stat.exists
  tags:
    - govtak

- name: Update existing tak-server repository
  ansible.builtin.git:
    repo: "{{ tak_server_repo_url }}"
    dest: "{{ tak_server_dir }}"
    update: yes
    force: yes
  when: tak_server_repo_exists.stat.exists
  tags:
    - govtak

- name: Ensure GovTAK Server scripts directory exists
  ansible.builtin.file:
    path: "{{ tak_server_scripts_dir }}"
    state: directory
    mode: '0755'
  tags:
    - govtak

- name: Check if scripts directory exists after git clone
  ansible.builtin.stat:
    path: "{{ tak_server_scripts_dir }}"
  register: scripts_dir_stat
  tags:
    - govtak

- name: Create scripts directory if it doesn't exist
  ansible.builtin.file:
    path: "{{ tak_server_scripts_dir }}"
    state: directory
    mode: '0755'
  when: not scripts_dir_stat.stat.exists
  tags:
    - govtak

- name: Copy GovTAK Server scripts to device
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ tak_server_scripts_dir }}/{{ item | basename }}"
    mode: '0755'
  loop:
    - setup.sh
    - certDP.sh
    - shareCerts.sh
  tags:
    - govtak

- name: Copy docker-compose.arm.yml to device
  ansible.builtin.copy:
    src: docker-compose.arm.yml
    dest: "{{ tak_server_dir }}/docker-compose.arm.yml"
    mode: '0644'
  tags:
    - govtak

- name: Check if TAK Server ZIP file is specified
  ansible.builtin.assert:
    that:
      - tak_server_zip_path != ""
    fail_msg: "TAK Server ZIP file path must be specified. Set tak_server_zip_path variable (e.g., -e 'tak_server_zip_path=~/Downloads/takserver-docker-5.6-RELEASE.zip')"
    success_msg: "TAK Server ZIP file path is specified"
  when: tak_server_run_setup | bool
  tags:
    - govtak

- name: Check if local TAK Server ZIP file exists
  ansible.builtin.stat:
    path: "{{ tak_server_zip_path | expanduser }}"
  register: tak_server_zip_local_stat
  delegate_to: localhost
  when: tak_server_zip_path != ""
  tags:
    - govtak

- name: Fail if TAK Server ZIP file does not exist locally
  ansible.builtin.fail:
    msg: "TAK Server ZIP file not found: {{ tak_server_zip_path }}"
  when:
    - tak_server_zip_path != ""
    - not tak_server_zip_local_stat.stat.exists
  tags:
    - govtak

- name: Determine TAK Server ZIP filename
  ansible.builtin.set_fact:
    tak_server_zip_filename: "{{ tak_server_zip_name if tak_server_zip_name != '' else (tak_server_zip_path | basename) }}"
  when: tak_server_zip_path != ""
  tags:
    - govtak

- name: Transfer TAK Server ZIP file to device
  ansible.builtin.copy:
    src: "{{ tak_server_zip_path | expanduser }}"
    dest: "{{ tak_server_dir }}/{{ tak_server_zip_filename }}"
    mode: '0644'
  when: tak_server_zip_path != ""
  tags:
    - govtak

- name: Verify deployment
  ansible.builtin.shell: |
    ls -lh {{ tak_server_scripts_dir }}/*.sh {{ tak_server_dir }}/docker-compose.arm.yml 2>/dev/null || echo "Some files missing"
  register: govtak_verify
  changed_when: false
  failed_when: false
  tags:
    - govtak

- name: Display deployment verification
  ansible.builtin.debug:
    msg: "{{ govtak_verify.stdout_lines }}"
  tags:
    - govtak

- name: Display TAK Server ZIP status
  ansible.builtin.debug:
    msg: |
      TAK Server ZIP file: {{ tak_server_zip_filename if tak_server_zip_path != '' else 'Not specified' }}
      Location on device: {{ tak_server_dir }}/{{ tak_server_zip_filename if tak_server_zip_path != '' else 'N/A' }}
      To run setup: cd {{ tak_server_dir }} && chmod +x scripts/setup.sh && ./scripts/setup.sh
  when: tak_server_zip_path != ""
  tags:
    - govtak

- name: Check if TAK Server is already configured
  ansible.builtin.stat:
    path: "{{ tak_server_dir }}/tak/CoreConfig.xml"
  register: tak_server_configured
  when: tak_server_run_setup | bool
  tags:
    - govtak
    - govtak-setup

- name: Check if TAK Server containers are running
  ansible.builtin.shell: |
    docker ps --filter "name=tak" --format "{{ '{{' }}.Names{{ '}}' }}" | grep -q tak && echo "RUNNING" || echo "NOT_RUNNING"
  when: 
    - tak_server_run_setup | bool
    - tak_server_configured.stat.exists
  register: tak_containers_running
  changed_when: false
  failed_when: false
  tags:
    - govtak
    - govtak-setup

- name: Display TAK Server already configured message
  ansible.builtin.debug:
    msg: |
      TAK Server is already configured (tak directory exists).
      Containers are {{ 'running' if tak_containers_running.stdout == 'RUNNING' else 'stopped' }}.
      Skipping setup to preserve existing configuration.
      
      To re-run setup, you must manually clean up:
      1. Stop containers: cd {{ tak_server_dir }} && docker-compose -f docker-compose.arm.yml down
      2. Remove tak directory: rm -rf {{ tak_server_dir }}/tak
      3. Remove docker volume: docker volume rm tak-server_db_data
      
      Or set tak_server_force_setup=true to force cleanup and re-setup (WARNING: Deletes all data!)
  when:
    - tak_server_run_setup | bool
    - tak_server_configured.stat.exists
    - tak_server_force_setup | default(false) | bool == false
  tags:
    - govtak
    - govtak-setup

- name: Clean up existing TAK Server installation (force setup)
  ansible.builtin.shell: |
    cd {{ tak_server_dir }}
    docker-compose -f docker-compose.arm.yml down 2>/dev/null || true
    rm -rf tak /tmp/takserver
    docker volume rm --force tak-server_db_data 2>/dev/null || true
  when:
    - tak_server_run_setup | bool
    - tak_server_configured.stat.exists
    - tak_server_force_setup | default(false) | bool
  tags:
    - govtak
    - govtak-setup

- name: Ensure local certs directory exists
  ansible.builtin.file:
    path: "{{ tak_server_certs_local_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  tags:
    - govtak
    - govtak-setup

- name: Start TAK Server setup script in background
  ansible.builtin.shell: |
    cd {{ tak_server_dir }}
    chmod +x scripts/setup.sh
    nohup bash -c 'echo "y" | ./scripts/setup.sh 2>&1 | tee /tmp/setup_output.txt' > /dev/null 2>&1 &
    echo $!
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  register: setup_pid
  changed_when: false
  tags:
    - govtak
    - govtak-setup

- name: Monitor and display setup progress
  ansible.builtin.shell: |
    echo "============================================================"
    echo "Setup Progress Check:"
    echo "============================================================"
    if [ -f /tmp/setup_output.txt ]; then
      if grep -q "MAKE A NOTE OF YOUR PASSWORDS" /tmp/setup_output.txt 2>/dev/null; then
        echo "STATUS: SETUP_COMPLETE"
        echo ""
        echo "Last 5 lines of output:"
        tail -n 5 /tmp/setup_output.txt
        echo "============================================================"
        exit 0
      else
        echo "STATUS: SETUP_IN_PROGRESS"
        echo ""
        echo "Last 10 lines of output:"
        tail -n 10 /tmp/setup_output.txt
        echo "============================================================"
        exit 1
      fi
    else
      echo "STATUS: WAITING_FOR_START"
      echo "Output file not found yet. Waiting for setup to start..."
      echo "============================================================"
      exit 1
    fi
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  register: setup_progress
  changed_when: false
  failed_when: setup_progress.rc != 0
  until: setup_progress.rc == 0
  retries: 240
  delay: 10
  tags:
    - govtak
    - govtak-setup

- name: Wait for setup to complete
  ansible.builtin.wait_for:
    path: /tmp/setup_output.txt
    state: present
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  tags:
    - govtak
    - govtak-setup

- name: Read setup output file
  ansible.builtin.slurp:
    src: /tmp/setup_output.txt
  register: setup_output_file
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  tags:
    - govtak
    - govtak-setup

- name: Extract passwords from setup output
  ansible.builtin.set_fact:
    setup_output_text: "{{ setup_output_file.content | b64decode | default('') }}"
    tak_admin_password: "{{ ((setup_output_file.content | b64decode | default('')) | regex_search('Admin password: ([^\\n\\r]+)', '\\1') | default([])) | first | default('Password not found in output') }}"
    tak_postgres_password: "{{ ((setup_output_file.content | b64decode | default('')) | regex_search('PostgreSQL password: ([^\\n\\r]+)', '\\1') | default([])) | first | default('Password not found in output') }}"
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
    - setup_output_file.content is defined
  tags:
    - govtak
    - govtak-setup

- name: Display admin credentials
  ansible.builtin.debug:
    msg: |
      ========== TAK SERVER CREDENTIALS ==========
      Admin username: admin
      Admin password: {{ tak_admin_password }}
      PostgreSQL password: {{ tak_postgres_password }}
      ============================================
      Web interface: https://{{ ansible_host | default(inventory_hostname) }}:8443
      IMPORTANT: Save these passwords - they won't be shown again!
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
    - tak_admin_password is defined
  tags:
    - govtak
    - govtak-setup

- name: Wait for TAK Server to be fully ready
  ansible.builtin.pause:
    seconds: 30
    prompt: "Waiting 30 seconds for TAK Server to fully initialize before creating user certificates..."
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  tags:
    - govtak
    - govtak-setup

- name: Get TAK container name
  ansible.builtin.shell: |
    docker ps --filter "name=tak" --format "{{ '{{' }}.Names{{ '}}' }}" | head -1
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  register: tak_container_name_result
  changed_when: false
  tags:
    - govtak
    - govtak-setup

- name: Set TAK container name
  ansible.builtin.set_fact:
    tak_container_name: "{{ tak_container_name_result.stdout | default('tak-server-tak-1') }}"
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  tags:
    - govtak
    - govtak-setup

- name: Create user certificates for martin and leon
  ansible.builtin.shell: |
    docker exec -w /opt/tak/certs {{ tak_container_name }} ./makeCert.sh client "{{ item }}"
  loop: "{{ tak_server_user_accounts }}"
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  register: makecert_result
  tags:
    - govtak
    - govtak-setup

- name: Display certificate creation results
  ansible.builtin.debug:
    msg: "Created certificate for {{ item.item }}: {{ 'SUCCESS' if item.rc == 0 else 'FAILED' }}"
  loop: "{{ makecert_result.results | default([]) }}"
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
    - makecert_result.results is defined
  tags:
    - govtak
    - govtak-setup

- name: Create data packages for user certificates
  ansible.builtin.shell: |
    cd {{ tak_server_dir }}
    ./scripts/certDP.sh "{{ ansible_host | default(ansible_default_ipv4.address) }}" "{{ item }}"
  loop: "{{ tak_server_user_accounts }}"
  when: 
    - tak_server_run_setup | bool
    - (not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool)
  tags:
    - govtak
    - govtak-setup

- name: Check if TAK Server is configured (for certs tag)
  ansible.builtin.stat:
    path: "{{ tak_server_dir }}/tak/CoreConfig.xml"
  register: tak_server_configured_for_certs
  tags:
    - govtak-certs

- name: Find all certificate files on device
  ansible.builtin.find:
    paths: "{{ tak_server_dir }}/tak/certs/files"
    patterns:
      - "*.p12"
      - "*.zip"
      - "*.pem"
    recurse: false
  when: 
    - (tak_server_run_setup | bool and ((not tak_server_configured.stat.exists) or (tak_server_force_setup | default(false) | bool))) or (tak_server_configured_for_certs.stat.exists | default(false))
  register: cert_files
  tags:
    - govtak
    - govtak-setup
    - govtak-certs

- name: Ensure local certs directory exists (for certs tag)
  ansible.builtin.file:
    path: "{{ tak_server_certs_local_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost
  when: tak_server_configured_for_certs.stat.exists | default(false)
  tags:
    - govtak-certs

- name: Download all certificates to local machine
  ansible.builtin.fetch:
    src: "{{ item.path }}"
    dest: "{{ tak_server_certs_local_dir }}/{{ item.path | basename }}"
    flat: yes
  loop: "{{ cert_files.files | default([]) }}"
  when: 
    - cert_files.files is defined
    - cert_files.files | length > 0
  tags:
    - govtak
    - govtak-setup
    - govtak-certs

- name: Display certificate download summary
  ansible.builtin.debug:
    msg: |
      Certificates downloaded to: {{ tak_server_certs_local_dir }}
      Files downloaded: {{ cert_files.files | length }}
      User accounts created: {{ tak_server_user_accounts | join(', ') }}
  when: 
    - cert_files.files is defined
    - cert_files.files | length > 0
  tags:
    - govtak
    - govtak-setup
    - govtak-certs

