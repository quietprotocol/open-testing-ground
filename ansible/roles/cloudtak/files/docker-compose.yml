services:
    api:
        dns_search: []
        dns:
            - "${DNS_SERVER:-192.168.0.1}"
        build:
          context: ./api/
          dockerfile: Dockerfile
          network: host
        restart: 'always'
        depends_on:
            - postgis
            - media
            - store
        ports:
            - "5000:5000"
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5001/api"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 60s
        environment:
            - CLOUDTAK_Mode=${CLOUDTAK_Mode}
            - CLOUDTAK_Config_media_url=${CLOUDTAK_Config_media_url}
            - SigningSecret=${SigningSecret}
            - ASSET_BUCKET=${ASSET_BUCKET}
            - AWS_S3_Endpoint=${AWS_S3_Endpoint}
            - AWS_S3_AccessKeyId=${AWS_S3_AccessKeyId}
            - AWS_S3_SecretAccessKey=${AWS_S3_SecretAccessKey}
            - POSTGRES=${POSTGRES}
            - API_URL=${API_URL}
            - PMTILES_URL=${PMTILES_URL}

    tiles:
        build:
          context: ./tasks/pmtiles/
          dockerfile: Dockerfile.compose
          network: host
        restart: 'always'
        ports:
            - "5002:5002"
        environment:
            - PMTILES_URL=${PMTILES_URL}
            - SigningSecret=${SigningSecret}
            - ASSET_BUCKET=${ASSET_BUCKET}
            - AWS_S3_Endpoint=${AWS_S3_Endpoint}
            - AWS_S3_AccessKeyId=${AWS_S3_AccessKeyId}
            - AWS_S3_SecretAccessKey=${AWS_S3_SecretAccessKey}

    events:
        build:
          context: ./tasks/events/
          dockerfile: Dockerfile
          network: host
        restart: 'always'
        depends_on:
            api:
                condition: service_healthy
            store:
                condition: service_started
        ports:
            - "5003:5003"
        environment:
            - CLOUDTAK_Mode=${CLOUDTAK_Mode}
            - API_URL=http://api:5001
            - SigningSecret=${SigningSecret}
            - ASSET_BUCKET=${ASSET_BUCKET}
            - AWS_S3_Endpoint=${AWS_S3_Endpoint}
            - AWS_S3_AccessKeyId=${AWS_S3_AccessKeyId}
            - AWS_S3_SecretAccessKey=${AWS_S3_SecretAccessKey}

    media:
        image: bluenviron/mediamtx:latest
        restart: 'always'
        volumes:
            - ./media/mediamtx.yml:/mediamtx.yml:ro
        ports:
            - "${MEDIA_PORT_API:-9997}:9997"
            - "${MEDIA_PORT_RTSP:-8554}:8554"
            - "${MEDIA_PORT_RTMP:-1935}:1935"
            - "${MEDIA_PORT_HLS:-8888}:8888"
            - "${MEDIA_PORT_SRT:-8890}:8890"
            - "${MEDIA_PORT_WEBRTC:-8889}:8889"
        command: ["/mediamtx.yml"]

    postgis:
        image: imresamu/postgis-arm64:latest
        restart: 'always'
        ports:
            - 5433:5432
        environment:
            - POSTGRES_DB=gis
            - POSTGRES_USER=docker
            - POSTGRES_PASSWORD=docker

    store:
        image: minio/minio:RELEASE.2024-08-17T01-24-54Z
        entrypoint: sh
        command: -c 'mkdir -p /data/cloudtak && /usr/bin/minio server /data --console-address ":9002"'
        restart: 'always'
        volumes:
            - .docker-store:/data
        ports:
            - 9000:9000
            - 9002:9002
        environment:
            - MINIO_ROOT_USER=${MINIO_ROOT_USER}
            - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
            - MINIO_DEFAULT_BUCKETS=${ASSET_BUCKET}

networks:
    default:
        name: cloudtak_default
        driver: bridge
        driver_opts:
            com.docker.network.bridge.enable_ip_masquerade: "true"
        ipam:
            config:
                - subnet: 172.20.0.0/16
