---
# OpenTAKServer deployment role

- name: Install required packages for OpenTAKServer
  ansible.builtin.shell: |
    opkg update
    opkg install git-http git openssh-client bash unzip coreutils-sha1sum htop || true
  args:
    creates: /usr/bin/git
  tags:
    - ots
    - ots-setup

- name: Ensure OpenTAKServer directory exists
  ansible.builtin.file:
    path: "{{ opentakserver_dir }}"
    state: directory
    mode: '0755'
  tags:
    - ots
    - ots-certs

- name: Check if persistent directory exists
  ansible.builtin.stat:
    path: "{{ opentakserver_dir }}/persistent"
  register: persistent_dir_exists
  tags:
    - ots

- name: Check if ots-docker repository exists
  ansible.builtin.stat:
    path: "{{ opentakserver_dir }}/.git"
  register: ots_repo_exists
  tags:
    - ots

- name: Clone ots-docker repository
  ansible.builtin.git:
    repo: https://github.com/milsimdk/ots-docker.git
    dest: "{{ opentakserver_dir }}"
    update: yes
    force: yes
  when: not persistent_dir_exists.stat.exists
  tags:
    - ots

- name: Update ots-docker repository
  ansible.builtin.git:
    repo: https://github.com/milsimdk/ots-docker.git
    dest: "{{ opentakserver_dir }}"
    update: yes
    force: yes
  when: 
    - persistent_dir_exists.stat.exists
    - ots_repo_exists.stat.exists
  tags:
    - ots

- name: Get timestamp for backup
  ansible.builtin.shell:
    cmd: date +%s
  register: backup_timestamp
  changed_when: false
  when: compose_backup | default(true)
  tags:
    - ots

- name: Backup existing compose.yaml if it exists
  ansible.builtin.copy:
    src: "{{ opentakserver_dir }}/compose.yaml"
    dest: "{{ opentakserver_dir }}/compose.yaml.backup.{{ backup_timestamp.stdout }}"
    remote_src: yes
  when: 
    - compose_backup | default(true)
    - backup_timestamp is defined
  ignore_errors: true
  changed_when: false
  tags:
    - ots

- name: Copy compose.yaml to device
  ansible.builtin.copy:
    src: compose.yaml
    dest: "{{ opentakserver_dir }}/compose.yaml"
    mode: '0644'
  tags:
    - ots

- name: Ensure nginx templates directory exists
  ansible.builtin.file:
    path: "{{ opentakserver_dir }}/persistent/nginx/templates"
    state: directory
    mode: '0755'
  tags:
    - ots
    - ots-certs

- name: Ensure nginx templates includes.d directory exists
  ansible.builtin.file:
    path: "{{ opentakserver_dir }}/persistent/nginx/templates/includes.d"
    state: directory
    mode: '0755'
  tags:
    - ots
    - ots-certs

- name: Ensure nginx includes directory exists
  ansible.builtin.file:
    path: "{{ opentakserver_dir }}/persistent/nginx/includes"
    state: directory
    mode: '0755'
  tags:
    - ots
    - ots-certs

- name: Copy nginx certificate include file to templates
  ansible.builtin.copy:
    src: includes.d/opentakserver_certificate
    dest: "{{ opentakserver_dir }}/persistent/nginx/templates/includes.d/opentakserver_certificate"
    mode: '0644'
  tags:
    - ots
    - ots-certs

- name: Copy nginx certificate include file to includes (runtime)
  ansible.builtin.copy:
    src: includes.d/opentakserver_certificate
    dest: "{{ opentakserver_dir }}/persistent/nginx/includes/opentakserver_certificate"
    mode: '0644'
  tags:
    - ots
    - ots-certs

- name: Ensure certificate directory exists on remote host
  ansible.builtin.file:
    path: "{{ opentakserver_dir }}/{{ ots_cert_remote_path }}"
    state: directory
    mode: '0755'
  tags:
    - ots
    - ots-certs

- name: Expand local certificate path
  ansible.builtin.set_fact:
    expanded_cert_path: "{{ ots_cert_local_path | expanduser }}"
  delegate_to: localhost
  tags:
    - ots
    - ots-certs

- name: Find certificate files on local machine
  ansible.builtin.find:
    paths: "{{ expanded_cert_path }}"
    patterns:
      - "{{ ots_cert_fullchain }}"
      - "{{ ots_cert_key }}"
      - "{{ ots_cert_ca }}"
    recurse: false
  register: local_cert_files
  delegate_to: localhost
  tags:
    - ots
    - ots-certs

- name: Copy certificate files to remote host
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "{{ opentakserver_dir }}/{{ ots_cert_remote_path }}/{{ (item.path | basename | regex_replace('.*\\.key$', 'privkey.key')) }}"
    mode: '{{ "0600" if ".key" in item.path else "0644" }}'
    remote_src: false
  loop: "{{ local_cert_files.files | default([]) }}"
  when: local_cert_files.files is defined and local_cert_files.files | length > 0
  tags:
    - ots
    - ots-certs

- name: Display certificate deployment summary
  ansible.builtin.debug:
    msg: |
      Certificates deployed to: {{ opentakserver_dir }}/{{ ots_cert_remote_path }}
      Files copied: {{ local_cert_files.files | default([]) | length }}
      Certificate files:
      {% for file in local_cert_files.files | default([]) %}
      - {{ file.path | basename }} (mode: {{ "0600" if "key" in file.path else "0644" }})
      {% endfor %}
  when: local_cert_files.files is defined and local_cert_files.files | length > 0
  tags:
    - ots
    - ots-certs

- name: Copy fixed nginx http-80.conf.template
  ansible.builtin.copy:
    src: http-80.conf.template
    dest: "{{ opentakserver_dir }}/persistent/nginx/templates/http-80.conf.template"
    mode: '0644'
  tags:
    - ots

- name: Copy fixed nginx https-443.conf.template
  ansible.builtin.copy:
    src: https-443.conf.template
    dest: "{{ opentakserver_dir }}/persistent/nginx/templates/https-443.conf.template"
    mode: '0644'
  tags:
    - ots

- name: Copy fixed nginx https-8443.conf.template
  ansible.builtin.copy:
    src: https-8443.conf.template
    dest: "{{ opentakserver_dir }}/persistent/nginx/templates/https-8443.conf.template"
    mode: '0644'
  tags:
    - ots

- name: Copy fixed nginx https-8446.conf.template
  ansible.builtin.copy:
    src: https-8446.conf.template
    dest: "{{ opentakserver_dir }}/persistent/nginx/templates/https-8446.conf.template"
    mode: '0644'
  tags:
    - ots

- name: Verify deployment
  ansible.builtin.shell:
    cmd: |
      ls -lh {{ opentakserver_dir }}/compose.yaml
      echo ""
      echo "Port mappings in compose.yaml:"
      grep -E "0\.0\.0\.0:[0-9]+:[0-9]+" {{ opentakserver_dir }}/compose.yaml | head -10
  register: ots_verify
  changed_when: false
  tags:
    - ots

- name: Display deployment verification
  ansible.builtin.debug:
    msg: "{{ ots_verify.stdout_lines }}"
  tags:
    - ots

- name: Start OpenTAKServer services
  ansible.builtin.shell:
    cmd: docker compose up -d
    chdir: "{{ opentakserver_dir }}"
  register: ots_start
  tags:
    - ots
    - ots-start

- name: Display start output
  ansible.builtin.debug:
    msg: "{{ ots_start.stdout_lines }}"
  tags:
    - ots
    - ots-start

- name: Check OpenTAKServer service status
  ansible.builtin.shell:
    cmd: docker compose ps
    chdir: "{{ opentakserver_dir }}"
  register: ots_status
  changed_when: false
  tags:
    - ots
    - ots-start

- name: Display service status
  ansible.builtin.debug:
    msg: "{{ ots_status.stdout_lines }}"
  tags:
    - ots
    - ots-start

