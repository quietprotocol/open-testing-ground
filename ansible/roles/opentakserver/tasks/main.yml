---
# OpenTAKServer deployment role

- name: Ensure OpenTAKServer directory exists
  ansible.builtin.file:
    path: "{{ opentakserver_dir }}"
    state: directory
    mode: '0755'
  tags:
    - ots

- name: Backup existing compose.yaml if it exists
  ansible.builtin.copy:
    src: "{{ opentakserver_dir }}/compose.yaml"
    dest: "{{ opentakserver_dir }}/compose.yaml.backup.{{ ansible_date_time.epoch }}"
    remote_src: yes
  when: compose_backup | default(true)
  ignore_errors: true
  changed_when: false
  tags:
    - ots

- name: Copy compose.yaml to device
  ansible.builtin.copy:
    src: compose.yaml
    dest: "{{ opentakserver_dir }}/compose.yaml"
    mode: '0644'
  tags:
    - ots

- name: Verify deployment
  ansible.builtin.command:
    cmd: |
      ls -lh {{ opentakserver_dir }}/compose.yaml
      echo ""
      echo "Port mappings in compose.yaml:"
      grep -E "0\.0\.0\.0:[0-9]+:[0-9]+" {{ opentakserver_dir }}/compose.yaml | head -10
  register: ots_verify
  changed_when: false
  tags:
    - ots

- name: Display deployment verification
  ansible.builtin.debug:
    msg: "{{ ots_verify.stdout_lines }}"
  tags:
    - ots

